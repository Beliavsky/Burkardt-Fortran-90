<html>

  <head>
    <title>
      F90_CALLS_C++ - FORTRAN90 code Calls C++ Function
    </title>
  </head>

  <body bgcolor="#eeeeee" link="#cc0000" alink="#ff3300" vlink="#000055">

    <h1 align = "center">
      F90_CALLS_C++ <br> FORTRAN90 code Calls C++ Function
    </h1>

    <hr>

    <p>
      <b>F90_CALLS_C++</b>,
      FORTRAN90 codes which
      demonstrate how a FORTRAN90 code can
      call a C++ function in a way that is "guaranteed" to work; in other
      words, the procedure follows rules laid down by the FORTRAN standard,
      and does not depend on any special or peculiar features of the
      FORTRAN and C++ compilers used to compile the codes.
    </p>

    <p>
      Some reference books discuss this topic by showing little isolated
      pieces of code, which do not form a real code, and cannot actually
      be compiled or used.  Since EVERYTHING has to be correctly written and
      working properly together to make this delicate operation happen, it
      is very important to have an entire calculation in mind, and to be able
      to examine the full FORTRAN and C++ source code, as well as the compile
      and load statements used.
    </p>

    <p>
      The KRONROD example presented here involves a FORTRAN90 main code
      and a code of 4 C++ functions.  For comparison, you can also look at
      a directory where the same calculation is done with the main code
      and code routines written in the same language.  Simply go to
      the KRONROD directory for the language you are interested in.
    </p>

    <p>
      The C++ functions used here are quite simple, and essentially
      are really C functions.  In fact, this same example is available with
      the functions written explicitly in C.  The differences between
      that C example and this C++ version are simply
      <ul>
        <li>
          the functions are written in C++, and invoke C++ libraries
          and IO.
        </li>
        <li>
          the compile statement for the functions uses the C++ compiler;
        </li>
        <li>
          the load statement must explicitly request the standard C++ code;
        </li>
      </ul>
    </p>

    <p>
      This example does not show how to pass data that needs to have the
      form of a structure.  It also does not deal with classes.
    </p>

    <p>
      A FORTRAN90 code, subroutine, or function that will call a C++ function
      might try using the ISO C binding module.  This was actually introduced
      as part of FORTRAN 2003, but your compiler may be willing to let your
      FORTRAN90 code access it.  (If not, you might consider moving to
      FORTRAN 2003!).  The ISO C bindings are made available by the statement:
      <pre>
        use iso_c_binding
      </pre>
      You can also use fussier versions of this statement, such as
      <pre>
        use, intrinsic :: iso_c_binding
      </pre>
      or
      <pre>
        use, intrinsic :: iso_c_binding, only : C_CHAR, C_NULL_CHAR
      </pre>
      (Thanks to Alan Richardson for pointing out that the ISO C bindings
      were only added to the language in the 2003 definition of FORTRAN!)
    </p>

    <p>
      Then you need to define an interface to the C++ function, which might read:
      <pre>
  interface
    subroutine kronrod ( n, eps, x, w1, w2 ) bind ( c )
      use iso_c_binding
      integer ( c_int ), VALUE :: n
      real ( c_double ), VALUE :: eps
      real ( c_double ) :: x(*)
      real ( c_double ) :: w1(*)
      real ( c_double ) :: w2(*)
    end subroutine kronrod
  end interface
      </pre>
    </p>

    <p>
      Finally, to guarantee that FORTRAN and C++ agree on data types, you should
      declare any FORTRAN90 variables that will be passed through the C interface
      with statements like:
      <pre>
  integer ( c_int ), parameter :: n = 3
  real ( c_double ) eps
  real ( c_double ) x(n+1)
  real ( c_double ) w1(n+1)
  real ( c_double ) w2(n+1)
      </pre>
    </p>

    <p>
      A special requirement when C++ is involved is that the <b>extern "C"</b>
      qualifier be used with all the function names that must be "visible" to
      the FORTRAN90 code.  For this example, we simple declare all the C++
      functions this way:
      <pre>
extern "C" 
{
  void abwe1 ( int n, int m, double eps, double coef2, bool even, double b[], 
    double *x, double *w );
  void abwe2 ( int n, int m, double eps, double coef2, bool even, double b[], 
    double *x, double *w1, double *w2 );
  void kronrod ( int n, double eps, double x[], double w1[], double w2[] );
  double r8_abs ( double x );
  void timestamp ( );
}
      </pre>
    </p>

    <h3 align = "center">
      Licensing:
    </h3>

    <p>
      The computer code and data files described and made available on this web page
      are distributed under
      <a href = "https://www.gnu.org/licenses/lgpl-3.0.en.html">the GNU LGPL license.</a>
    </p>

    <h3 align = "center">
      Languages:
    </h3>

    <p>
      <b>F90_CALLS_C++</b> is available in 
      <a href = "../../f_src/f90_calls_c++/f90_calls_c++.html">a FORTRAN90 version</a> 
    </p>

    <h3 align = "center">
      Related Data and codes:
    </h3>

    <p>
      <a href = "../../c_src/c_calls_f77/c_calls_f77.html">
      C_CALLS_F77</a>,
      C codes which
      call a FORTRAN77 subroutine.
    </p>

    <p>
      <a href = "../../c_src/c_calls_f90/c_calls_f90.html">
      C_CALLS_F90</a>,
      C codes which
      call a FORTRAN90 subroutine.
    </p>

    <p>
      <a href = "../../cpp_src/c++_calls_f77/c++_calls_f77.html">
      C++_CALLS_F77</a>,
      C++ codes which
      call a FORTRAN77 subroutine.
    </p>

    <p>
      <a href = "../../cpp_src/c++_calls_f90/c++_calls_f90.html">
      C++_CALLS_F90</a>,
      C++ codes which
      call a FORTRAN90 subroutine.
    </p>

    <p>
      <a href = "../../f77_src/f77_calls_c/f77_calls_c.html">
      F77_CALLS_C</a>,
      FORTRAN77 codes which
      call a C function.
    </p>

    <p>
      <a href = "../../f77_src/f77_calls_c++/f77_calls_c++.html">
      F77_CALLS_C++</a>,
      FORTRAN77 codes which
      call a C++ function.
    </p>

    <p>
      <a href = "../../f_src/f90_calls_c/f90_calls_c.html">
      F90_CALLS_C</a>,
      FORTRAN90 codes which
      call C to carry out an auxillary calculation.
    </p>

    <p>
      <a href = "../../f_src/f90_calls_matlab/f90_calls_matlab.html">
      F90_CALLS_MATLAB</a>,
      FORTRAN90 codes which
      call MATLAB to carry out an auxillary calculation.
    </p>

    <p>
      <a href = "../../f_src/f90_stop_test/f90_stop_test.html">
      f90_stop_test</a>,</a>,
      FORTRAN90 codes which
      illustrate how a FORTRAN90 code can print a text message
      or return a numeric code status value to the calling environment
      when executing the STOP statement.
    </p>

    <p>
      <a href = "../../cpp_src/kronrod/kronrod.html">
      KRONROD</a>,
      a C++ code which
      can compute a Gauss and Gauss-Kronrod pair of
      quadrature rules of arbitrary order, by Robert Piessens, Maria Branders.
    </p>

    <p>
      <a href = "../../m_src/matlab_calls_c/matlab_calls_c.html">
      MATLAB_CALLS_C</a>,
      MATLAB codes which
      call a C function using the MEX facility;
    </p>

    <p>
      <a href = "../../m_src/matlab_calls_f77/matlab_calls_f77.html">
      MATLAB_CALLS_F77</a>,
      MATLAB codes which
      call a FORTRAN77 function,
      using MATLAB's MEX facility.
    </p>

    <p>
      <a href = "../../c_src/mixed/mixed.html">
      MIXED</a>,
      C codes which
      call a function written in another codeming language.
    </p>

    <p>
      <a href = "../../cpp_src/mixed/mixed.html">
      MIXED</a>,,
      C++ codes which
      call a function written in another codeming language.
    </p>

    <p>
      <a href = "../../f77_src/mixed/mixed.html">
      MIXED</a>,
      FORTRAN77 codes which
      call a function written in another codeming language.
    </p>

    <p>
      <a href = "../../f_src/mixed/mixed.html">
      MIXED</a>,
      is a directory of FORTRAN90 codes which
      call a function written in another codeming language.
    </p>

    <h3 align = "center">
      Reference:
    </h3>

    <p>
      <ul>
        <li>
          The gfortran team,<br>
          Using GNU Fortran,<br>
          The Free Software Foundation, 2010.
        </li>
        <li>
          Fritz Keinert,<br>
          Mathematics Department,<br>
          Iowa State University,<br>
          Calling FORTRAN Subroutines from Fortran, C and C++.
        </li>
        <li>
          Michael Metcalf,<br>
          Fortran95/2003 Explained,<br>
          Oxford, 2004,<br>
          ISBN: 0198526938,<br>
          LC: QA76.73.F235.M48.
        </li>
        <li>
          Yang Wang, Raghurama Reddy, Roberto Gomez, Junwoo Lim, Sergiu Sanielevici,
          Jaideep Ray, James Sutherland, Jackie Chen,<br>
          A General Approach to Creating Fortran Interface for C++ Application Libraries,<br>
          Current Trends in High Performance Computing and its Applications, pages 145-154,<br>
          edited by Wu Zhang, Zhangxin Chen, Roland Glowinski, Weiqin Tong,<br>
          Springer, 2005,<br>
          ISBN13: 978-3540257851,<br>
          LC: QA76.88.I5663.
        </li>
      </ul>
    </p>

    <h3 align = "center">
      Source Code:
    </h3>

    <p>
      The <b>KRONROD</b> example involves a FORTRAN90 main code
      which calls directly the C++ functions "kronrod" and "timestamp".
      <ul>
        <li>
          <a href = "kronrod_test.f90">kronrod_test.f90</a>, the main code;
        </li>
        <li>
          <a href = "kronrod.cpp">kronrod.cpp</a>, the code routines;
        </li>
        <li>
          <a href = "kronrod.hpp">kronrod.hpp</a>, an include file;
        </li>
        <li>
          <a href = "kronrod.txt">kronrod.txt</a>,
          the output file.
        </li>
      </ul>
    </p>

    <hr>

    <i>
      Last revised on 18 July 2012.
    </i>

    <!-- John Burkardt -->

  </body>

</html>

